<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EventEye - AI Certificate Automation</title>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; line-height: 1.6; color: #333; background-color: #f8fafc; }
        .container { max-width: 1200px; margin: 0 auto; padding: 0 20px; }
        header { background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%); color: white; padding: 1rem 0; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); }
        .header-content { display: flex; justify-content: space-between; align-items: center; }
        .header-actions { display: flex; align-items: center; gap: 1rem; }
        .logo { display: flex; align-items: center; gap: 10px; }
        .logo-icon { width: 40px; height: 40px; background: white; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-weight: bold; color: #2563eb; }
        .logo-text { font-size: 1.5rem; font-weight: bold; }
        .tabs { display: flex; background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); }
        .tab { padding: 12px 24px; background: none; border: none; cursor: pointer; font-weight: 500; transition: all 0.3s ease; }
        .tab.active { background: #2563eb; color: white; }
        main { padding: 2rem 0; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .hero { text-align: center; margin-bottom: 2rem; }
        .hero h1 { font-size: 2.5rem; margin-bottom: 1rem; color: #1e293b; }
        .hero p { font-size: 1.2rem; color: #64748b; max-width: 600px; margin: 0 auto; }
        .card { background: white; border-radius: 12px; padding: 2rem; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05); margin-bottom: 2rem; }
        .card h2 { margin-bottom: 1.5rem; color: #1e293b; font-size: 1.5rem; }
        .form-group { margin-bottom: 1.5rem; }
        label { display: block; margin-bottom: 0.5rem; font-weight: 500; color: #374151; }
        input { width: 100%; padding: 12px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 1rem; transition: border-color 0.3s; }
        input:focus { outline: none; border-color: #2563eb; box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1); }
        .file-upload { border: 2px dashed #d1d5db; padding: 2rem; text-align: center; border-radius: 8px; transition: all 0.3s; cursor: pointer; }
        .file-upload:hover { border-color: #2563eb; background: #f8fafc; }
        .file-upload input { display: none; }
        .checkbox-group { display: flex; align-items: center; gap: 10px; margin-bottom: 1rem; }
        .checkbox-group label { margin-bottom: 0; }
        .btn { display: inline-block; padding: 12px 24px; background: #2563eb; color: white; border: none; border-radius: 8px; font-size: 1rem; font-weight: 500; cursor: pointer; transition: all 0.3s; text-align: center; }
        .btn:hover:not(:disabled) { background: #1d4ed8; transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); }
        .btn:disabled { background: #9ca3af; cursor: not-allowed; transform: none; box-shadow: none; }
        .btn-secondary { background: #6b7280; }
        .btn-danger { background: #ef4444; }
        .btn-success { background: #10b981; }
        .btn-warning { background: #f59e0b; }
        .loading-spinner { display: inline-block; width: 20px; height: 20px; border: 3px solid rgba(255,255,255,.3); border-radius: 50%; border-top-color: white; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .certificate { background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%); border: 12px solid transparent; background-clip: padding-box; position: relative; padding: 3rem; margin: 0; text-align: center; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15); min-height: 600px; display: flex; flex-direction: column; justify-content: space-between; }
        .certificate::before { content: ""; position: absolute; top: 0; left: 0; right: 0; bottom: 0; border: 12px solid; border-image: linear-gradient(135deg, #f59e0b, #dc2626, #2563eb, #10b981) 1; pointer-events: none; z-index: -1; }
        .certificate::after { content: ""; position: absolute; top: 24px; left: 24px; right: 24px; bottom: 24px; border: 2px solid #e5e7eb; pointer-events: none; }
        .certificate-title { font-size: 3rem; background: linear-gradient(135deg, #1e40af, #7c3aed); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; font-weight: 800; letter-spacing: 2px; text-transform: uppercase; margin-bottom: 0.5rem; }
        .certificate-subtitle { font-size: 1.1rem; color: #6b7280; margin: 1rem 0; font-weight: 400; letter-spacing: 0.5px; }
        .certificate-name { font-family: 'Georgia', 'Times New Roman', serif; font-size: 3.5rem; background: linear-gradient(135deg, #1e3a8a, #3b82f6); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; margin: 2rem 0; font-weight: 700; font-style: italic; text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.05); padding: 1rem 0; border-top: 2px solid #e5e7eb; border-bottom: 2px solid #e5e7eb; }
        .certificate-event { font-size: 1.8rem; color: #1f2937; margin: 1.5rem 0; font-weight: 700; letter-spacing: 0.5px; }
        .certificate-footer { display: flex; justify-content: space-between; align-items: flex-end; margin-top: 3rem; padding-top: 2rem; }
        .certificate-signature { text-align: center; width: 180px; }
        .signature-line { width: 180px; height: 2px; background: linear-gradient(90deg, transparent, #374151, transparent); margin: 10px auto; }
        .certificate-actions { display: flex; gap: 1rem; justify-content: center; margin-top: 1.5rem; }
        .certificate-qr { text-align: center; }
        .certificate-qr img { width: 100px; height: 100px; }
        .certificate-qr p { font-size: 0.7rem; color: #6b7280; margin-top: 5px; }
        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem; margin-bottom: 2rem; }
        .stat-card { background: white; padding: 1.5rem; border-radius: 12px; text-align: center; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05); }
        .stat-number { font-size: 2.5rem; font-weight: bold; margin-bottom: 0.5rem; }
        .stat-label { color: #6b7280; font-size: 0.9rem; }
        .certificate-list { margin-top: 1rem; }
        .certificate-item, .event-list-item { display: flex; justify-content: space-between; align-items: center; padding: 1rem; border-bottom: 1px solid #e5e7eb; gap: 1rem; }
        .certificate-item:last-child, .event-list-item:last-child { border-bottom: none; }
        .certificate-info, .event-info { flex-grow: 1; }
        .certificate-info h4, .event-info h3 { margin-bottom: 0.5rem; }
        .certificate-info p, .event-info p { color: #6b7280; font-size: 0.9rem; }
        .resend-count { font-size: 0.8rem; color: #9ca3af; margin-left: 8px; }
        .status-badge { display: inline-block; padding: 4px 12px; border-radius: 20px; font-size: 0.8rem; font-weight: 500; min-width: 80px; text-align: center; }
        .status-sent { background: #dbeafe; color: #1e40af; }
        .status-failed { background: #fee2e2; color: #991b1b; }
        .status-sending { background: #fef3c7; color: #92400e; }
        .status-not_sent { background: #e5e7eb; color: #4b5563; }
        .message { padding: 1rem; border-radius: 8px; margin-bottom: 1rem; position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 1000; box-shadow: 0 4px 10px rgba(0,0,0,0.1); min-width: 300px; text-align: center;}
        .message-success { background: #d1fae5; color: #065f46; }
        .message-error { background: #fee2e2; color: #991b1b; }
        .message-warning { background: #fef3c7; color: #92400e; }
        .message-info { background: #dbeafe; color: #1e40af; }
        .hidden { display: none !important; }
        .text-center { text-align: center; }
        .viewer-mode { display: none; padding: 2rem; }
        .viewer-mode.active { display: block; }
        .create-event-form { margin-top: 2rem; border-top: 1px solid #e5e7eb; padding-top: 1.5rem; display: flex; gap: 1rem; }
        .create-event-form input { flex-grow: 1; }
        .automation-hub { display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; }
        .automation-log { background: #1e293b; color: #e2e8f0; font-family: monospace; padding: 1.5rem; border-radius: 8px; height: 350px; overflow-y: auto; font-size: 0.9rem; }
        .automation-log p { margin: 0 0 0.5rem; }
        .log-success { color: #4ade80; }
        .log-error { color: #f87171; }
        .log-info { color: #60a5fa; }
        .manual-tools { display: flex; gap: 2rem; margin-top: 2rem; }
        .manual-tools > .card { flex: 1; margin-bottom: 0; }
        .ai-suggestions { margin-top: 1.5rem; border-top: 1px solid #e5e7eb; padding-top: 1.5rem; }
        .suggestion-item { display: flex; justify-content: space-between; align-items: center; padding: 0.5rem; border-radius: 6px; }
        .suggestion-item:nth-child(odd) { background-color: #f9fafb; }
        .suggestion-item p { margin: 0; flex-grow: 1; display: flex; align-items: center; gap: 8px;}
        .suggestion-item .original { text-decoration: line-through; color: #ef4444; }
        .suggested-input { border: 1px solid #10b981; border-radius: 4px; padding: 4px 8px; font: inherit; color: #059669; font-weight: 500; }
        @media print { body > * { visibility: hidden; } .certificate-print-area, .certificate-print-area * { visibility: visible; } .certificate-print-area { position: absolute; left: 0; top: 0; width: 100%; height: 100%; padding: 0; margin: 0; display: flex; justify-content: center; align-items: center; } .certificate { margin: 0; box-shadow: none; max-width: 95%; max-height: 95%; } .no-print { display: none !important; } }
    </style>
</head>
<body>
    <div id="viewer-mode" class="viewer-mode">
        <div id="viewer-certificate-container" class="certificate-print-area"></div>
        <div id="viewer-actions" class="certificate-actions no-print">
            <button class="btn" onclick="downloadCertificate('PNG')">Download as PNG</button>
            <button class="btn" onclick="downloadCertificate('PDF')">Download as PDF</button>
            <button class="btn btn-secondary" onclick="window.print()">Print</button>
        </div>
    </div>
        
    <div id="event-selection-page">
        <header><div class="container"><div class="header-content"><div class="logo"><div class="logo-icon">E</div><div class="logo-text">EventEye</div></div></div></div></header>
        <main class="container">
            <div class="hero"><h1>My Events</h1><p>Select an event to manage or create a new one.</p></div>
            <div class="card">
                <h2>All Saved Events</h2>
                <div id="event-list" class="certificate-list"></div>
                <div class="create-event-form"><input type="text" id="new-event-name" placeholder="Enter new event name..."><button id="create-event-btn" class="btn btn-success">Create New Event</button></div>
            </div>
        </main>
    </div>

    <div id="event-workspace" class="hidden">
        <header class="no-print">
            <div class="container"><div class="header-content"><div class="header-actions"><button id="back-to-events-btn" class="btn btn-secondary">‚Äπ My Events</button><div class="logo" style="margin-left: 1rem;"><div class="logo-icon">E</div><div class="logo-text">EventEye</div></div></div><div class="header-actions"><div class="tabs"><button class="tab active" data-tab="generator">Automation Hub</button><button class="tab" data-tab="dashboard">Dashboard</button></div></div></div></div>
        </header>
        <main class="container">
            <div id="generator-tab" class="tab-content active">
                <div class="card">
                    <div class="automation-hub">
                        <div>
                            <h2>1. Event & Participant Data</h2>
                            <div class="form-group"><label for="event-name">Event Name</label><input type="text" id="event-name"></div>
                            <div class="form-group"><label for="organizer-name">Organizer Name</label><input type="text" id="organizer-name"></div>
                            <div class="form-group"><label for="certificate-date">Certificate Date</label><input type="date" id="certificate-date"></div>
                            <div class="form-group"><label>Upload Participant List (CSV)</label><div class="file-upload" id="file-upload-area"><p>üìÅ Click to upload CSV (name, email)</p><input type="file" id="file-input" accept=".csv"></div><div id="file-preview" class="hidden"><p class="message message-success">‚úÖ <span id="participant-count">0</span> participants loaded</p></div></div>
                        </div>
                        <div>
                            <h2>2. Automation Settings</h2>
                            <div class="checkbox-group"><input type="checkbox" id="auto-verify-ai" checked><label for="auto-verify-ai">Auto-verify & correct names with AI</label></div>
                            <div class="checkbox-group"><input type="checkbox" id="auto-send-email" checked><label for="auto-send-email">Auto-send emails upon generation</label></div>
                            <div class="form-group" style="margin-top: 2rem;">
                                <button id="run-automation-btn" class="btn btn-success" style="width: 100%; font-size: 1.2rem; padding: 1rem;" disabled>‚ñ∂Ô∏è Run Full Automation</button>
                            </div>
                            <div id="automation-log-container" class="form-group">
                                <label>Live Progress Log</label>
                                <div id="automation-log" class="automation-log"><p>Ready to start...</p></div>
                            </div>
                        </div>
                    </div>
                </div>
                                
                <div class="manual-tools">
                    <div class="card no-print">
                        <h2>Manual Tools</h2>
                        <div class="form-group">
                            <button class="btn" id="verify-data-manual" disabled>Verify Names Manually</button>
                        </div>
                        <div id="ai-suggestions-box" class="ai-suggestions hidden"><h4>AI Suggestions:</h4><div id="ai-suggestions-list"></div></div>
                         <div class="form-group" style="margin-top: 2rem; border-top: 1px solid #eee; padding-top: 1.5rem;">
                            <button class="btn btn-secondary" id="preview-certificates" disabled>Preview Certificate</button>
                        </div>
                    </div>
                    <div class="card no-print">
                        <h2>Send Single Certificate</h2>
                        <div class="form-group"><label for="custom-participant-name">Participant Name</label><input type="text" id="custom-participant-name" placeholder="Enter name"></div>
                        <div class="form-group"><label for="custom-participant-email">Participant Email</label><input type="email" id="custom-participant-email" placeholder="Enter email"></div>
                        <button id="custom-send-btn" class="btn btn-success">Generate & Send Single</button>
                    </div>
                </div>

                <div id="certificate-preview-card" class="card hidden">
                    <h2 class="no-print">Certificate Preview</h2>
                    <div id="certificate-preview-output" class="certificate-print-area"></div>
                    <div id="preview-actions" class="certificate-actions no-print"><button class="btn" onclick="downloadCertificate('PNG')">Download PNG</button><button class="btn" onclick="downloadCertificate('PDF')">Download PDF</button><button class="btn btn-secondary" onclick="window.print()">Print</button></div>
                </div>
            </div>

            <div id="dashboard-tab" class="tab-content">
                 <div class="hero"><h1>Certificate Dashboard</h1><p id="dashboard-subtitle">Track certificates for your event.</p></div>
                <div class="stats">
                    <div class="stat-card"><div class="stat-number" id="total-certificates">0</div><div class="stat-label">Total Certificates</div></div>
                    <div class="stat-card"><div class="stat-number" id="emails-sent">0</div><div class="stat-label">Emails Sent</div></div>
                    <div class="stat-card"><div class="stat-number" id="emails-failed">0</div><div class="stat-label">Emails Failed</div></div>
                    <div class="stat-card"><div class="stat-number" id="not-sent">0</div><div class="stat-label">Not Sent</div></div>
                </div>
                <div class="card">
                    <h2>All Certificates</h2>
                    <p class="text-center hidden" id="no-certificates-message">No certificates generated yet.</p>
                    <div id="all-certificates-list" class="certificate-list"></div>
                </div>
            </div>
        </main>
    </div>

<script>
    // --- CONFIGURATION ---
    const EMAILJS_PUBLIC_KEY = 'tZeth4DvK6-Whqzsg';
    const EMAILJS_SERVICE_ID = 'service_apx88y4';
    const EMAILJS_TEMPLATE_ID = 'template_9wknv6i';
    const OPENROUTER_API_KEY = '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';
    
    // --- SUPABASE SETUP ---
    const SUPABASE_URL = 'https://fmwvpaqkavycvxdovshq.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZtd3ZwYXFrYXZ5Y3Z4ZG92c2hxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkxMzg4MjYsImV4cCI6MjA3NDcxNDgyNn0.32OrkJfHaS5HmaGb5K3lrz2omG0hHVHd-Tur0TWgMsA';
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // --- GLOBAL STATE MANAGEMENT ---
    (function() { emailjs.init({ publicKey: EMAILJS_PUBLIC_KEY }); })();

    let appData = { activeEventId: null, events: {} };
    let state = getNewStateObject();

    function getNewStateObject() { 
        return { 
            eventData: { name: '', organizer: '', date: '' }, 
            participants: [], 
            certificates: [] 
        }; 
    }

    // --- INITIALIZATION ---
    document.addEventListener('DOMContentLoaded', () => { 
        if (!checkViewerMode()) {
            initializeApp();
        }
    });

    async function initializeApp() {
        await loadAppDataFromDB();
        setupEventListeners();
        showEventSelectionPage();
    }

    function setupEventListeners() {
        // Main App Listeners
        document.querySelectorAll('.tab').forEach(tab => tab.addEventListener('click', () => switchTab(tab.dataset.tab)));
        document.getElementById('event-name').addEventListener('input', updateEventData);
        document.getElementById('organizer-name').addEventListener('input', updateEventData);
        document.getElementById('certificate-date').addEventListener('change', updateEventData);
        document.getElementById('file-upload-area').addEventListener('click', () => document.getElementById('file-input').click());
        document.getElementById('file-input').addEventListener('change', handleFileUpload);
        document.getElementById('back-to-events-btn').addEventListener('click', showEventSelectionPage);
        document.getElementById('create-event-btn').addEventListener('click', createNewEvent);
        document.getElementById('run-automation-btn').addEventListener('click', runFullAutomation);
        document.getElementById('verify-data-manual').addEventListener('click', () => performAiVerification(false));
        document.getElementById('preview-certificates').addEventListener('click', previewCertificates);
        document.getElementById('custom-send-btn').addEventListener('click', sendSingleCertificate);
    }
    
    // --- DATABASE (SUPABASE) FUNCTIONS ---
    async function loadAppDataFromDB() {
        try {
            const { data, error } = await supabase.from('events').select('*');
            if (error) throw error;
            appData.events = {};
            data.forEach(event => {
                appData.events[event.id] = {
                    eventData: event.event_data || { name: 'Untitled', organizer: '', date: '' },
                    participants: event.participants || [],
                    certificates: event.certificates || []
                };
            });
        } catch (error) {
            console.error('Error loading data from Supabase:', error);
            showMessage('Could not load event data from the database.', 'error');
        }
    }

    async function saveActiveEventToDB() {
        if (!appData.activeEventId) return;
        syncStateWithAppData();
        const currentEventState = appData.events[appData.activeEventId];
        try {
            const { error } = await supabase
                .from('events')
                .update({ 
                    event_data: currentEventState.eventData,
                    participants: currentEventState.participants,
                    certificates: currentEventState.certificates
                })
                .eq('id', appData.activeEventId);
            if (error) throw error;
        } catch (error) {
            console.error('Error saving event to Supabase:', error);
            showMessage('Failed to save changes to the database.', 'error');
        }
    }

    // --- EVENT MANAGEMENT & UI FLOW ---
    function showEventSelectionPage() {
        document.getElementById('event-workspace').classList.add('hidden');
        document.getElementById('viewer-mode').classList.remove('active');
        document.getElementById('event-selection-page').classList.remove('hidden');
        renderEventManager();
    }

    function showEventWorkspace() {
        document.getElementById('event-selection-page').classList.add('hidden');
        document.getElementById('event-workspace').classList.remove('hidden');
    }

    function renderEventManager() {
        const list = document.getElementById('event-list');
        list.innerHTML = '';
        if (Object.keys(appData.events).length === 0) {
            list.innerHTML = '<p class="text-center" style="padding: 1rem 0;">No events found. Create one below to get started!</p>';
            return;
        }
        for (const eventId in appData.events) {
            const eventState = appData.events[eventId];
            const item = document.createElement('div');
            item.className = 'event-list-item';
            item.innerHTML = `
                <div class="event-info">
                    <h3>${eventState.eventData.name || 'Untitled Event'}</h3>
                    <p>${eventState.participants.length} participants, ${eventState.certificates.length} certificates</p>
                </div>
                <div>
                    <button class="btn">Load Event</button>
                    <button class="btn btn-danger" style="margin-left: 10px;">Delete</button>
                </div>`;
            item.querySelector('.btn').addEventListener('click', () => loadAndShowWorkspace(eventId));
            item.querySelector('.btn-danger').addEventListener('click', (e) => { e.stopPropagation(); deleteEvent(eventId); });
            list.appendChild(item);
        }
    }

    async function createNewEvent() {
        const eventNameInput = document.getElementById('new-event-name');
        const eventName = eventNameInput.value.trim();
        if (!eventName) { alert('Please enter an event name.'); return; }
        const newEventId = `event-${Date.now()}`;
        const newEventState = getNewStateObject();
        newEventState.eventData.name = eventName;
        try {
            const { error } = await supabase
                .from('events')
                .insert([{ id: newEventId, event_data: newEventState.eventData, participants: newEventState.participants, certificates: newEventState.certificates }])
                .select();
            if (error) throw error;
            appData.events[newEventId] = newEventState;
            loadAndShowWorkspace(newEventId);
            eventNameInput.value = '';
            showMessage('Event created successfully!', 'success');
        } catch (error) {
            console.error('Error creating event:', error);
            showMessage('Failed to create event. Please try again.', 'error');
        }
    }

    function loadAndShowWorkspace(eventId) {
        if (!appData.events[eventId]) return;
        appData.activeEventId = eventId;
        state = JSON.parse(JSON.stringify(appData.events[eventId]));
        updateUIFromState();
        showEventWorkspace();
    }

    async function deleteEvent(eventId) {
        const eventName = appData.events[eventId]?.eventData?.name || 'this event';
        if (!confirm(`Are you sure you want to delete "${eventName}"? This cannot be undone.`)) return;
        try {
            const { error } = await supabase.from('events').delete().eq('id', eventId);
            if (error) throw error;
            delete appData.events[eventId];
            if (appData.activeEventId === eventId) {
                appData.activeEventId = null;
                state = getNewStateObject();
                showEventSelectionPage();
            } else {
                renderEventManager();
            }
            showMessage('Event deleted successfully!', 'success');
        } catch (error) {
            console.error('Error deleting event:', error);
            showMessage('Failed to delete event. Please try again.', 'error');
        }
    }
    
    // --- STATE & UI SYNC ---
    function syncStateWithAppData() {
        if (!appData.activeEventId) return;
        appData.events[appData.activeEventId] = JSON.parse(JSON.stringify(state));
    }

    function updateUIFromState() {
        document.getElementById('event-name').value = state.eventData.name || '';
        document.getElementById('organizer-name').value = state.eventData.organizer || '';
        document.getElementById('certificate-date').value = state.eventData.date || '';
        document.getElementById('dashboard-subtitle').textContent = `Tracking certificates for "${state.eventData.name || 'Current Event'}"`;
        document.getElementById('ai-suggestions-box').classList.add('hidden');
        document.getElementById('certificate-preview-card').classList.add('hidden');
        updateFilePreview();
        updateDashboard();
        checkButtonStates();
    }

    function checkButtonStates() {
        const eventDataValid = validateEventData(false);
        const participantsExist = state.participants.length > 0;
        const readyForAutomation = eventDataValid && participantsExist;

        document.getElementById('run-automation-btn').disabled = !readyForAutomation;
        document.getElementById('verify-data-manual').disabled = !participantsExist;
        document.getElementById('preview-certificates').disabled = !readyForAutomation;
    }
    
    // --- CORE APPLICATION LOGIC ---
    function switchTab(tabId) {
        document.querySelectorAll('.tab').forEach(t => t.classList.toggle('active', t.dataset.tab === tabId));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.toggle('active', c.id === `${tabId}-tab`));
        if (tabId === 'dashboard') updateDashboard();
    }

    async function updateEventData() { 
        state.eventData = { name: document.getElementById('event-name').value.trim(), organizer: document.getElementById('organizer-name').value.trim(), date: document.getElementById('certificate-date').value };
        await saveActiveEventToDB();
        checkButtonStates();
    }

    function handleFileUpload(event) {
        const file = event.target.files[0]; if (!file) return;
        state.participants = []; state.certificates = [];
        const reader = new FileReader();
        reader.onload = async (e) => {
            try {
                const jsonData = parseCSV(e.target.result);
                state.participants = jsonData.map((row, index) => ({ 
                    id: index + 1, 
                    name: (row.name || `P ${index + 1}`).trim(), 
                    email: (row.email || '').trim() 
                }));
                updateFilePreview();
                await saveActiveEventToDB();
                log(`CSV file processed. Found ${state.participants.length} participants.`, 'success');
            } catch (error) { showMessage('Error reading CSV file.', 'error'); log('Error reading CSV file.', 'error'); }
        };
        reader.readAsText(file);
    }

    function parseCSV(csvText) {
        const lines = csvText.split('\n').filter(line => line.trim());
        if (lines.length < 2) return [];
        const headers = lines[0].split(',').map(h => h.trim().toLowerCase().replace(/"/g, ''));
        return lines.slice(1).map(line => {
            const values = line.match(/(".*?"|[^",\s]+)(?=\s*,|\s*$)/g) || line.split(',');
            return headers.reduce((obj, header, index) => {
                obj[header] = (values[index] || '').trim().replace(/"/g, '');
                return obj;
            }, {});
        });
    }

    function updateFilePreview() {
        const preview = document.getElementById('file-preview');
        if (state.participants.length > 0) {
            preview.classList.remove('hidden');
            document.getElementById('participant-count').textContent = state.participants.length;
        } else {
            preview.classList.add('hidden');
        }
        checkButtonStates();
    }
    
    const logContainer = document.getElementById('automation-log');
    function log(message, type = 'info') {
        const p = document.createElement('p');
        p.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
        p.className = `log-${type}`;
        logContainer.appendChild(p);
        logContainer.scrollTop = logContainer.scrollHeight;
    }

    async function runFullAutomation() {
        if (!validateEventData(true)) return;
        const button = document.getElementById('run-automation-btn');
        button.disabled = true;
        button.innerHTML = '<span class="loading-spinner"></span> Running Automation...';
        logContainer.innerHTML = ''; 
        try {
            log(`Starting automation for event "${state.eventData.name}"...`, 'info');
            if (state.participants.length === 0) throw new Error('No participants loaded.');
            log(`${state.participants.length} participants ready.`, 'success');

            if (document.getElementById('auto-verify-ai').checked) {
                log('Sending names to AI for verification...', 'info');
                const corrections = await performAiVerification(true); 
                if (corrections && corrections.length > 0) {
                    log(`AI found ${corrections.length} potential corrections. Applying automatically...`, 'info');
                    corrections.forEach(c => {
                        const participant = state.participants.find(p => p.id === c.id);
                        if (participant) participant.name = c.suggestedName;
                    });
                    log('All AI corrections applied.', 'success');
                } else {
                    log('AI verification complete. No issues found.', 'success');
                }
            }

            log('Generating certificates...', 'info');
            state.certificates = state.participants.map(p => {
                const certData = { 
                    name: p.name, 
                    event: state.eventData.name, 
                    organizer: state.eventData.organizer, 
                    date: state.eventData.date 
                };
                return { 
                    id: generateCertificateId(), 
                    participant: p, 
                    event: state.eventData, 
                    generatedAt: new Date().toISOString(), 
                    urlData: btoa(JSON.stringify(certData)), 
                    emailStatus: 'not_sent', 
                    resendCount: 0 
                };
            });
            log(`${state.certificates.length} certificates generated successfully.`, 'success');
            
            if (document.getElementById('auto-send-email').checked) {
                log('Starting email distribution...', 'info');
                const emailPromises = state.certificates.map((cert, i) => 
                    sendCertificateEmail(cert).then(() => {
                        log(`Email progress: ${i + 1} / ${state.certificates.length}`, 'info');
                    })
                );
                await Promise.all(emailPromises);
                log('Email distribution complete.', 'success');
            }

            await saveActiveEventToDB();
            updateDashboard();
            log('Automation finished!', 'success');
            showMessage('Full automation complete! Check the dashboard for results.', 'success');
            switchTab('dashboard');
        } catch (error) {
            log(`Automation failed: ${error.message}`, 'error');
            console.error(error);
        } finally {
            button.disabled = false;
            button.innerHTML = '‚ñ∂Ô∏è Run Full Automation';
        }
    }

    async function performAiVerification(isAuto = false) {
        const button = document.getElementById('verify-data-manual');
        if (!isAuto) { button.disabled = true; button.innerHTML = '<span class="loading-spinner"></span> Verifying...'; }
        const prompt = `You are a data validation expert. I'll provide a JSON array of participants. Check each name for spelling/formatting errors. Return a JSON object with a key 'corrections', which is an array of objects. Each object needs 'id', 'originalName', and 'suggestedName'. If a name is correct, omit it from the array. If all names are correct, return an empty 'corrections' array. ONLY return the JSON object.`;
        const participantsToVerify = state.participants.map(p => ({ id: p.id, name: p.name }));
        try {
            const response = await fetch("https://openrouter.ai/api/v1/chat/completions", {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${OPENROUTER_API_KEY}`, 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    model: "mistralai/mistral-7b-instruct:free",
                    messages: [{ role: "user", content: `${prompt}\n\n${JSON.stringify(participantsToVerify)}` }],
                    response_format: { "type": "json_object" }
                })
            });
            if (!response.ok) throw new Error(`API Error: ${response.statusText}`);
            const data = await response.json();
            const resultJson = JSON.parse(data.choices[0].message.content);
            const corrections = resultJson.corrections || [];
            if (!isAuto) displayAiSuggestions(corrections);
            return corrections;
        } catch (error) {
            if (!isAuto) showMessage('AI verification failed.', 'error');
            console.error(error);
            if(isAuto) return [];
            throw error;
        } finally {
            if (!isAuto) { button.disabled = false; button.innerHTML = 'Verify Names Manually'; }
        }
    }

    function displayAiSuggestions(corrections) {
        const container = document.getElementById('ai-suggestions-box');
        const list = document.getElementById('ai-suggestions-list');
        list.innerHTML = '';
        if (corrections.length === 0) { showMessage('AI verification complete. No issues found!', 'success'); container.classList.add('hidden'); return; }
        showMessage(`${corrections.length} potential name corrections found.`, 'warning');
        corrections.forEach(correction => {
            const item = document.createElement('div');
            item.className = 'suggestion-item';
            item.innerHTML = `<p><span class="original">${correction.originalName}</span> ‚Üí <input type="text" class="suggested-input" value="${correction.suggestedName}"></p><button class="btn btn-success" style="padding: 4px 8px; font-size: 0.8rem;">Accept</button>`;
            item.querySelector('button').addEventListener('click', () => {
                const correctedName = item.querySelector('.suggested-input').value;
                acceptSuggestion(correction.id, correctedName, item);
            });
            list.appendChild(item);
        });
        container.classList.remove('hidden');
    }

    async function acceptSuggestion(participantId, suggestedName, itemElement) {
        const participant = state.participants.find(p => p.id === participantId);
        if (participant) {
            participant.name = suggestedName;
            showMessage(`Updated name for participant ID ${participantId}.`, 'success');
            itemElement.style.display = 'none';
            await saveActiveEventToDB();
        }
    }
    
    async function sendCertificateEmail(certificate) {
        if (!certificate.participant.email) { 
            certificate.emailStatus = 'failed'; 
            return;
        }
        
        certificate.emailStatus = 'sending';
        const shareableUrl = `${window.location.origin}${window.location.pathname}?data=${certificate.urlData}`;
        const templateParams = { to_name: certificate.participant.name, to_email: certificate.participant.email, event_name: certificate.event.name, organizer_name: certificate.event.organizer, certificate_url: shareableUrl };
        
        try {
            await emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_ID, templateParams);
            certificate.emailStatus = 'sent';
        } catch (error) {
            certificate.emailStatus = 'failed';
            console.error(`Email failed for ${certificate.participant.email}:`, error);
            showMessage(`Email to ${certificate.participant.name} failed.`, 'error');
        }
    }
    
    async function sendSingleCertificate() {
        if (!validateEventData(true)) return;
        const nameInput = document.getElementById('custom-participant-name');
        const emailInput = document.getElementById('custom-participant-email');
        const name = nameInput.value.trim(); 
        const email = emailInput.value.trim();
        if (!name || !email) { showMessage('Please enter both name and email.', 'error'); return; }

        const newParticipant = { id: (state.participants.length + 1), name, email };
        state.participants.push(newParticipant);
        const certData = { name: newParticipant.name, event: state.eventData.name, organizer: state.eventData.organizer, date: state.eventData.date };
        const newCertificate = { id: generateCertificateId(), participant: newParticipant, event: state.eventData, generatedAt: new Date().toISOString(), urlData: btoa(JSON.stringify(certData)), emailStatus: 'not_sent', resendCount: 0 };
        state.certificates.push(newCertificate);
        
        showMessage(`Generated certificate for ${name}. Sending email...`, 'info');
        await sendCertificateEmail(newCertificate);
        
        await saveActiveEventToDB();
        updateDashboard();
        nameInput.value = ''; 
        emailInput.value = '';
        switchTab('dashboard');
    }

    function generateCertificateId() { return 'CERT-' + Date.now() + '-' + Math.random().toString(36).slice(2, 8).toUpperCase(); }
    
    function generateCertificateHTML(certificate) {
        const date = certificate.event.date ? new Date(certificate.event.date + 'T00:00:00').toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' }) : 'N/A';
        const shareableUrl = `${window.location.origin}${window.location.pathname}?data=${certificate.urlData}`;
        const qrUrl = `${shareableUrl}&source=qr`;
        const qrCodeImgUrl = `https://api.qrserver.com/v1/create-qr-code/?data=${encodeURIComponent(qrUrl)}&size=100x100&qzone=1`;
        return `<div class="certificate"><div class="certificate-title">Certificate of Completion</div><div class="certificate-subtitle">This certificate is proudly presented to</div><div class="certificate-name">${certificate.participant.name}</div><div class="certificate-subtitle">for successfully completing the</div><div class="certificate-event">${certificate.event.name}</div><div class="certificate-subtitle">organized by</div><div style="font-size: 1.3rem; font-weight: bold; margin: 1rem 0;">${certificate.event.organizer}</div><div class="certificate-footer"><div class="certificate-signature"><div class="signature-line"></div><div>Date</div><div style="margin-top: 5px;">${date}</div></div><div class="certificate-qr"><img src="${qrCodeImgUrl}" alt="Certificate QR Code"><p>Scan to Verify</p></div><div class="certificate-signature"><div class="signature-line"></div><div>Authorized Signature</div><div style="margin-top: 5px;">EventEye Team</div></div></div></div>`;
    }

    function previewCertificates() {
        if (!validateEventData(true) || state.participants.length === 0) { return; }
        const card = document.getElementById('certificate-preview-card');
        const output = document.getElementById('certificate-preview-output');
        const tempCertData = { name: state.participants[0].name, event: state.eventData.name, organizer: state.eventData.organizer, date: state.eventData.date };
        const tempCert = { participant: state.participants[0], event: state.eventData, urlData: btoa(JSON.stringify(tempCertData)) };
        output.innerHTML = generateCertificateHTML(tempCert);
        card.classList.remove('hidden');
        card.scrollIntoView({ behavior: 'smooth' });
    }

    function updateDashboard() {
        const certs = state.certificates;
        document.getElementById('total-certificates').textContent = certs.length;
        document.getElementById('emails-sent').textContent = certs.filter(c => c.emailStatus === 'sent').length;
        document.getElementById('emails-failed').textContent = certs.filter(c => c.emailStatus === 'failed').length;
        document.getElementById('not-sent').textContent = certs.filter(c => c.emailStatus === 'not_sent' || c.emailStatus === 'sending' || !c.emailStatus).length;
        const list = document.getElementById('all-certificates-list');
        const noCertMessage = document.getElementById('no-certificates-message');
        list.innerHTML = '';
        if (certs.length === 0) { noCertMessage.classList.remove('hidden'); } 
        else {
            noCertMessage.classList.add('hidden');
            certs.sort((a,b) => a.participant.name.localeCompare(b.participant.name)); // Sort alphabetically
            list.innerHTML = certs.map(c => {
                const emailStatus = c.emailStatus || 'not_sent';
                const resendText = c.resendCount > 0 ? `<span class="resend-count">(Resent ${c.resendCount} time${c.resendCount > 1 ? 's' : ''})</span>` : '';
                return `<div class="certificate-item"><div class="certificate-info"><h4>${c.participant.name}</h4><p>${c.participant.email || 'No email'} ${resendText}</p></div><div style="display: flex; align-items: center; gap: 10px;"><span class="status-badge status-${emailStatus.replace('_','-')}">${emailStatus.replace('_', ' ')}</span><button class="btn" style="padding: 8px 16px;" onclick="viewCertificate('${c.id}')">View</button>${(emailStatus !== 'sent') ? `<button class="btn btn-warning" style="padding: 8px 16px;" onclick="resendEmail('${c.id}')">Send / Resend</button>` : ''}</div></div>`;
            }).join('');
        }
    }
    
    async function resendEmail(certificateId) {
        const certificate = state.certificates.find(c => c.id === certificateId);
        if (certificate) { 
            certificate.resendCount = (certificate.resendCount || 0) + 1;
            showMessage(`Sending email to ${certificate.participant.name}... (Attempt #${certificate.resendCount})`, 'info');
            await sendCertificateEmail(certificate);
            updateDashboard();
            await saveActiveEventToDB();
        }
    }

    function viewCertificate(id) {
        const certificate = state.certificates.find(c => c.id === id);
        if (certificate) {
            const card = document.getElementById('certificate-preview-card');
            const output = document.getElementById('certificate-preview-output');
            output.innerHTML = generateCertificateHTML(certificate);
            card.classList.remove('hidden');
            switchTab('generator');
            card.scrollIntoView({ behavior: 'smooth' });
        }
    }
    
    function validateEventData(showAlerts = true) {
        if (!state.eventData.name || !state.eventData.organizer || !state.eventData.date) {
            if (showAlerts) showMessage('Event name, organizer, and date are required to proceed.', 'error');
            return false;
        }
        return true;
    }

    function showMessage(message, type = 'info') {
        const existingMsg = document.querySelector('.message-popup');
        if (existingMsg) existingMsg.remove();

        const msgDiv = document.createElement('div');
        msgDiv.className = `message message-${type} no-print message-popup`;
        msgDiv.textContent = message;
        document.body.appendChild(msgDiv);
        setTimeout(() => {
            msgDiv.style.transition = 'opacity 0.5s';
            msgDiv.style.opacity = '0';
            setTimeout(() => msgDiv.remove(), 500);
        }, 4500);
    }

    // --- VIEWER MODE & VERIFICATION ---
    function checkViewerMode() {
        const urlParams = new URLSearchParams(window.location.search);
        const certData = urlParams.get('data');

        if (certData) {
            try {
                const data = JSON.parse(atob(certData));
                const certificate = { 
                    participant: { name: data.name }, 
                    event: { name: data.event, organizer: data.organizer, date: data.date }, 
                    urlData: certData 
                };
                showCertificateViewer(certificate);
            } catch (e) { 
                console.error("Error displaying certificate from URL:", e);
                showViewerError(); 
            }
            return true; // Is in viewer mode
        }
        return false; // Not in viewer mode
    }
    
    function showCertificateViewer(certificate) {
        // Hide the main application sections
        document.getElementById('event-workspace').style.display = 'none';
        document.getElementById('event-selection-page').style.display = 'none';
        
        // Show the viewer mode parent container
        const viewer = document.getElementById('viewer-mode');
        viewer.classList.add('active');
        
        // Populate and un-hide the certificate itself
        const certContainer = document.getElementById('viewer-certificate-container');
        certContainer.innerHTML = generateCertificateHTML(certificate);
        certContainer.classList.remove('hidden');
        
        // Un-hide the action buttons (Download, Print)
        document.getElementById('viewer-actions').classList.remove('hidden');
    }

    function showViewerError() {
         document.getElementById('viewer-mode').classList.add('active');
         const container = document.getElementById('viewer-certificate-container');
         container.innerHTML = `<div class="card" style="margin-top: 4rem;"><div class="message message-error" style="position: static; transform: none;"><h2>Certificate Not Found</h2><p>The link may be invalid or the certificate data is corrupted.</p></div></div>`;
         container.classList.remove('hidden');
    }

    async function downloadCertificate(format) {
        const isViewer = document.getElementById('viewer-mode').classList.contains('active');
        const container = isViewer ? document.getElementById('viewer-certificate-container') : document.getElementById('certificate-preview-output');
        const certificateElement = container.querySelector('.certificate');
        if (!certificateElement) { showMessage('No certificate to download.', 'error'); return; }
        
        const participantName = certificateElement.querySelector('.certificate-name').textContent.trim();
        const eventName = certificateElement.querySelector('.certificate-event').textContent.trim();
        const fileName = `Certificate-${participantName.replace(/\s/g, '_')}-${eventName.replace(/\s/g, '_')}`;
        
        const actionButtons = container.parentElement.querySelector('.certificate-actions').querySelectorAll('button');
        actionButtons.forEach(btn => btn.disabled = true);
        
        showMessage(`Preparing download as ${format}...`, 'info');
        
        const originalShadow = certificateElement.style.boxShadow;
        certificateElement.style.boxShadow = 'none';
        
        try {
            const canvas = await html2canvas(certificateElement, { scale: 2.5, useCORS: true, backgroundColor: '#ffffff' });
            if (format === 'PNG') {
                const link = document.createElement('a');
                link.download = `${fileName}.png`;
                link.href = canvas.toDataURL('image/png');
                link.click();
            } else if (format === 'PDF') {
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF({ orientation: 'landscape', unit: 'px', format: [canvas.width, canvas.height] });
                pdf.addImage(canvas.toDataURL('image/png'), 'PNG', 0, 0, canvas.width, canvas.height);
                pdf.save(`${fileName}.pdf`);
            }
        } catch(err) {
            console.error("Download failed:", err);
            showMessage("Download could not be completed.", "error");
        } finally {
            certificateElement.style.boxShadow = originalShadow;
            actionButtons.forEach(btn => btn.disabled = false);
        }
    }
</script>
</body>
</html>
